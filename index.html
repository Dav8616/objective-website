<!DOCTYPE html>
<html>
<head>
    <title>Login Page</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #121212; color: white; text-align: center; }
        #login, #dashboard, #objectivesPage, #usersPage, #notificationsPage { display: none; }
        .container { max-width: 600px; margin: auto; padding: 20px; }
        .sidebar { position: fixed; left: 0; top: 0; width: 200px; height: 100%; background: #1e1e1e; padding: 10px; }
        .sidebar a { display: block; color: white; padding: 10px; text-decoration: none; border-bottom: 1px solid #444; }
        .sidebar a:hover { background: #333; }
        .top-bar { background-color: #333; padding: 10px; color: white; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
        .top-bar button { background-color: #555; color: white; border: none; padding: 10px; cursor: pointer; }
        .top-bar button:hover { background-color: #444; }
        .objective { margin-bottom: 10px; padding: 10px; background-color: #2a2a2a; border-radius: 5px; }
        .objective button { margin-left: 10px; }
        .notification { padding: 10px; background-color: #444; margin-bottom: 10px; border-radius: 5px; }
        .notification button { margin-left: 10px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="#" onclick="showPage('login')" id="loginLink">Login</a>
        <a href="#" id="dashboardLink" style="display:none;" onclick="showPage('dashboard')">Dashboard</a>
        <a href="#" id="objectivesLink" style="display:none;" onclick="showPage('objectivesPage')">Objectives</a>
        <a href="#" id="usersLink" style="display:none;" onclick="showPage('usersPage')">Users</a>
        <a href="#" id="notificationsLink" style="display:none;" onclick="showPage('notificationsPage')">Notifications</a>
    </div>
    
    <div class="container">
        <div id="login">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Enter Username"><br><br>
            <input type="password" id="password" placeholder="Enter Password"><br><br>
            <button onclick="checkLogin()">Login</button>
        </div>
        
        <div id="dashboard">
            <div class="top-bar">
                <span>Dashboard</span>
                <button onclick="logout()">Logout</button>
            </div>
            <h2>Welcome, <span id="role"></span>!</h2>
            <h3>Your Points: <span id="userPoints">0</span></h3>
        </div>

        <div id="objectivesPage">
            <div class="top-bar">
                <span>Objectives</span>
                <input type="text" id="newObjectiveName" placeholder="Objective Name">
                <input type="text" id="newObjectiveDescription" placeholder="Objective Description">
                <button onclick="addObjective()">Add Objective</button>
            </div>
            <ul id="objectiveList"></ul>
        </div>

        <div id="usersPage" style="display:none;">
            <div class="top-bar">
                <span>Users</span>
                <input type="text" id="newUsername" placeholder="New Username">
                <input type="password" id="newUserPass" placeholder="New User Password">
                <button onclick="addUser()">Add User</button>
            </div>
            <ul id="userList"></ul>
        </div>

        <div id="notificationsPage" style="display:none;">
            <div class="top-bar">
                <span>Notifications</span>
                <button onclick="clearNotifications()">Clear All</button>
            </div>
            <ul id="notificationList"></ul>
        </div>
    </div>
    
    <script>
        let users = {}; // No users initially
        let adminUsername = "admin";
        let adminPassword = btoa("adminpass"); // Encrypted password storage
        let objectives = [];
        let userPoints = {};
        let notifications = [];
        let currentUser = "";
        let repoOwner = 'your-username'; // GitHub username
        let repoName = 'your-repo-name'; // GitHub repo name
        let filePath = 'data.json'; // File to store the data
        let token = 'your-personal-access-token'; // Your GitHub personal access token

        document.getElementById("login").style.display = "block";
        
        // Load the data from the repository when the page loads
        window.onload = function() {
            loadDataFromGitHub();
        }

        // Function to load data from GitHub repository
        function loadDataFromGitHub() {
            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3.raw'
            };

            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}?ref=main`;

            fetch(apiUrl, { headers })
                .then(response => response.json())
                .then(data => {
                    if (data.message && data.message === 'Not Found') {
                        alert("File not found in GitHub repository. Creating a new one.");
                    } else {
                        const fileContent = atob(data.content); // Decode from base64
                        const jsonData = JSON.parse(fileContent);
                        users = jsonData.users || {};
                        objectives = jsonData.objectives || [];
                        userPoints = jsonData.userPoints || {};
                        notifications = jsonData.notifications || [];
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        // Function to update the data on GitHub repository
        function saveDataToGitHub() {
            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            };

            const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
            
            // Get the current SHA for the file (needed for the PUT request)
            fetch(apiUrl, { headers })
                .then(response => response.json())
                .then(data => {
                    const sha = data.sha;
                    const newData = {
                        users: users,
                        objectives: objectives,
                        userPoints: userPoints,
                        notifications: notifications
                    };

                    const fileContent = btoa(JSON.stringify(newData, null, 2)); // Encode content to base64

                    // PUT request to update the file
                    const putData = {
                        message: "Update data.json",
                        content: fileContent,
                        sha: sha
                    };

                    fetch(apiUrl, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify(putData)
                    })
                    .then(response => response.json())
                    .then(result => {
                        console.log('Data saved to GitHub:', result);
                    })
                    .catch(error => {
                        console.error('Error saving data:', error);
                    });
                })
                .catch(error => {
                    console.error('Error fetching file SHA:', error);
                });
        }

        // Existing functions (login, add objectives, add users, etc.) should call saveDataToGitHub() to persist changes
        function addObjective() {
            if (currentUser !== adminUsername) {
                alert("Only admins can add objectives!");
                return;
            }
            let name = document.getElementById("newObjectiveName").value;
            let description = document.getElementById("newObjectiveDescription").value;
            if (name && description) {
                objectives.push({ name, description });
                saveDataToGitHub(); // Save changes to GitHub
                updateObjectives();
            } else {
                alert("Both name and description are required.");
            }
        }

        function addUser() {
            let newUsername = document.getElementById("newUsername").value;
            let newUserPass = btoa(document.getElementById("newUserPass").value);
            if (newUsername && newUserPass) {
                users[newUsername] = newUserPass;
                saveDataToGitHub(); // Save changes to GitHub
                updateUserList();
                alert("New user added!");
            }
        }

        // Other functions should also call `saveDataToGitHub()` whenever changes occur

        // Example: When the user logs out, save the current data state
        function logout() {
            currentUser = "";
            saveDataToGitHub(); // Save data before logout
            showPage('login');
        }

        // Existing code for checking login, loading dashboard, adding objectives, etc. can be used as-is.
    </script>
</body>
</html>
